---
title: "Sprawozdanie  nr 1"
author: "Klaudia Janicka 262268 i Natalia Iwańska 262270"
date: "`r Sys.Date()`"
output: pdf_document 
header-includes:
 \usepackage{float}
 \floatplacement{figure}{H}
 \renewcommand{\figurename}{Wykres}
 \renewcommand{\tablename}{Tabela}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
knitr::opts_chunk$set(fig.width=5, fig.height=3) 
pdf.options(encoding = 'CP1250')
```

## 1. Wstęp

Niniejszy raport stanowi analizę danych rzeczywistych dotyczących trzęsień ziemi o skali wydarzenia powyżej 6 na przestrzeni lat 1900-2013. Dane pochodzą ze strony [kaggle.com](https://www.kaggle.com/datasets/varunsaikanuri/earthquakes-from-1900-2013). Zgodnie z informacjami zawartymi na podanej stronie źródłem danych jest United States Geological Survey.

Celem naszej analizy jest odpowiedzenie na pytanie jakie regiony są najbardziej narażone, zbadanie jakie czynniki mają wpływ na występowanie trzęsień ziemi oraz, czy poszczególne cechy trzęsienia są ze sobą powiązane. 


### 1.1 Opis zmiennych
Typy danych występujących w poszczególnych kolumnach:

```{r, echo=FALSE, results='asis', fig.cap='\\label{tabela}"Typy zmiennych dla danych zawartych pliku."'}
library(knitr)
earthquakes = read.csv("Earthquakes.csv")
df_type <- sapply(earthquakes, class)
kable(df_type, col.names=c('typ'))
```
Typy zawarte w tabeli \ref{tabela} oznaczają odpowiednio:

integer - typ całkowity, który przyjmuje wartości całkowite,

numeric - typ zmiennoprzecinkowy, który przyjmuje wartości ułamkowe,

character - typ znakowy, przechowuje łańcuchy tekstowe.

Do analizy wykorzystujemy dane zawarte w kolumnach:

- $place$ - tekstowy opis regionu geograficznego w pobliżu zdarzenia;
- $latitude$ - szerokość geograficzna podana w stopniach, przyjmuje wartości z przedziału $[-90, 90]$, gdzie wartości ujemne oznaczają południowe szerokości;
- $longitude$ - długość geograficzna podana w stopniach, przyjmuje wartości z przedziału $[-180, 180]$, gdzie wartości ujemne dotyczą zachodnich długości;
- $mag$ - skala zdarzenia;
- $nst$ - liczba stacji sejsmicznych użytych do określenia lokalizacji trzęsienia;
- $time$ - czas wystapienia trzęsienia;
- $depth$ - głębokość zdarzenia w kilometrach;
- $date$ - data zajścia zdarzenia;

gdzie jako zdarzenie rozumiemy wystąpienie trzęsienia ziemi.

Jako zmienne kategoryczne uznajemy zmienną $place$, która po transformacji wskazuje na kraj, w którym zdarzenie miało miejsce oraz $date$, która po transformacji oznacza miesiąc zajścia zdarzenia. Pozostałe zmienne to zmiennne ciągłe. (Tak myślę, ale może być inaczej;;; brzmi sensownie)


### 1.2 Obsługa błędów
Wiersze z brakami danych usuwamy za pomocą funkcji drop_na() z biblioteki dplyr.

## 2. Analiza danych

```{r include=FALSE}
# łysy chce alfabetycznie i wszystkie biblioteki w jednym miejscu <- do zrobienia
library("ggplot2")
library('corrplot')
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library(rgeos)
library(ggplot2)
library(stringr)
library(reshape)
library(maps)
library(tidyverse)
library(lubridate)
library(dplyr)

theme_set(theme_bw())
world <- ne_countries(scale = "medium", returnclass = "sf")
#map(database = "world")  <---- wywala mi błąd jak nie jest zakomentowane idk czemu; Rmd dziwak
```


### 2.1 Miejsca najbardziej narażone na trzęsienia ziemii

W celu ustalenia państw najbardziej narażonych na wystąpienie zdarzenia posłużymy się analizą graficzną.

```{r echo=FALSE, fig.cap="\\label{world}Mapa świata z naniesionymi miejscami trzęsień ziemi"}
### Mapka ###
eq_points_map_lg <- earthquakes$longitude
eq_points_map_lat <- earthquakes$latitude
dfmap <- data.frame(eq_points_map_lat,eq_points_map_lg)
dfmap <- dfmap %>% drop_na()

world <- map_data("world")

ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "white", fill = "lightgray", size = 0.1
  ) +
  geom_point(
    data = dfmap,
    aes(eq_points_map_lg, eq_points_map_lat, color = 'pink'),
    alpha = 0.7
  ) + labs(x='', y='')
```

Z powyższego wykresu \ref{world} i posiadanej wiedzy z zakresu geografii, jesteśmy w stanie stwierdzić, że najbardziej narażone są między innymi Chile, Japonia i inne kraje azjatyckie. 

```{r echo=FALSE, fig.cap="\\label{barplot1}Wykres słupkowy dla 12 najbardziej narażonych miejsc",fig.width=5, fig.height=3.5}
# 12 najczęstszych miejsc wybrane #
miejsce <- vapply(strsplit(earthquakes$place,","), `[`, 2, FUN.VALUE=character(1))

most_fr_eq <- data.frame(number=rev(sort(table(miejsce)))[1:12])
colnames(most_fr_eq)[1] <- 'miejsce'
colnames(most_fr_eq)[2] <- 'częstość'
most_fr_eq <- most_fr_eq %>% drop_na()

ggplot(most_fr_eq, aes(x = miejsce, y = częstość)) + geom_col(fill = 'hotpink') + 
  theme(axis.text.x = element_text(angle = 90)) + geom_text(aes(label = częstość), nudge_y = -20, col='white') +
  labs(x='kraj', y='liczba wystąpień') + 
  ggtitle('Wykres słupkowy dla 12 najbardziej narażonych miejsc')
```

Wykres \ref{barplot1} potwierdza nasze wcześniejsze przypuszczenia oparte o wykres \ref{world}. 

### 2.2 Macierz korelacji

```{r corrpl, echo=FALSE, fig.cap="\\label{corrpl}Macierz korelacji "}
years <- vapply(strsplit(earthquakes$Date,"-"), `[`, 1, FUN.VALUE=character(1))
df_allnum <- earthquakes
df_allnum$years <- years
keeps <- c("depth","mag",'years',"nst",'longitude','latitude')

df_allnum$years <- as.numeric(as.character(df_allnum$years))

df_allnum <- df_allnum[keeps]
df_allnum <- transform(df_allnum,as.numeric(years))
df_allnum <- df_allnum %>% drop_na()

corrplot(cor(df_allnum),method = 'color',col = COL2('PuOr'))

```

Jak widać na macierzy \ref{corrpl}, najsilniejsza korelacja występuje pomiędzy kolumną $nst$ oraz $years$. Dzięki temu możemy stwierdzić, że  w ciągu kolejnych lat powstawało coraz więcej stacji sejsmicznych, co możemy pokazać bardziej szczegółowo, tworząc poniższy wykres: 

```{r, echo=FALSE,fig.cap="\\label{nst_years}Scatterplot zależności liczby stacji sejsmicznych od lat." }
df_nst_years <- data.frame(years,earthquakes$nst)
colnames(df_nst_years)[2] <- 'nst'
df_nst_years <- df_nst_years %>% drop_na()

ggplot(df_nst_years,aes(x=years,y=nst)) + geom_point(color='hotpink') +labs(x='lata', y='liczba stacji sejsmicznych') +  scale_x_discrete(breaks=seq(1900, 2013, 10))
```

Zaskakiwać może fakt, że głębokość i siła trzęsienia nie są ze sobą silnie skorelowane, co możemy zobaczyć na wykresie poniżej: 

```{r, echo=FALSE, fig.cap="\\label{depth_mag}Scatterplot zależności siły trzęsienia od jego głębokości", fig.pos="H"}
dfmd <- data.frame(earthquakes$mag,earthquakes$depth)
colnames(dfmd)[1] <- 'siła'
colnames(dfmd)[2] <- 'głębokość'
dfmd <- dfmd %>% drop_na()

ggplot(dfmd,aes(x=głębokość,y=siła)) + geom_point(color='hotpink')
```

Reszta kolumn nie jest ze sobą tak silnie skorelowana i nie jest tak zaskakująca jak zależności wyżej. Większość wartości oscyluje wokół zera, więc nie będziemy im się bliżej przyglądać. 

### Stosunek ilości trzęsień ziemi do kolejnych lat

```{r, echo=FALSE,fig.cap="\\label{numb_years}Wykres kolumnowy ilości trzęsień ziemi w stosunku do lat"}
eq_to_years <- data.frame(number=sort(table(years)))
colnames(eq_to_years)[1] <- 'lata'
colnames(eq_to_years)[2] <- 'częstość'
eq_to_years <- eq_to_years %>% drop_na()

ggplot(eq_to_years,aes(x=lata,y=częstość)) + geom_col(color='hotpink') + scale_x_discrete(breaks=seq(1900, 2013, 15)) + theme(axis.text.x = element_text(angle = 90))
```

Na podstawie wykresu \ref{numb_years} można by przypuszczać, że wraz z upływem lat, przybywało trzęsień ziemi, jednak musimy wziąć pod uwagę fakt, że w tym samym czasie przybywało stacji sejsmicznych, które takie zdarzenia rejestrowały, co pokazaliśmy na wykresie \ref{nst_years}. Zatem nie możemy jednoznacznie stwierdzić, czy liczba trzęsień ziemi zmieniała się w konretny sposób. 

??? Czy to nie jest masło maślane XDDDDDDD Btw długie zdanie napisałam, a jak na polski się miało wymyślać to pustka XD co ta matma z człowiekiem robi. (sidenote: R dalej głupi)

Powiedzmy że będę nazywać je dosadnie, jakkolwiek głupio to brzmi, a więc: 
### Badanie wpływu pory roku na liczbę trzęsień ziemi

```{r, echo=FALSE, fig.cap="\\label{numb_season}Wykres kolumnowy ilości trzęsień ziemi w stosunku do miesiąca, w którym wystąpiły"}
miesiace <- vapply(strsplit(earthquakes$Date,"-"), `[`, 2, FUN.VALUE=character(1))

eq_to_months <- data.frame(number=table(miesiace))
colnames(eq_to_months)[1] <- 'miesiace'
colnames(eq_to_months)[2] <- 'częstość'
eq_to_months <- eq_to_months %>% drop_na()

ggplot(eq_to_months,aes(x=miesiace,y=częstość)) + geom_col(fill='hotpink') + theme(axis.text.x = element_text(angle = 90))
```

Na powyższym wykresie możemy zauważyć, że słupki dla wszystkich miesięcy są dość podobnej wysokości. Nie ma żadnych mocno odstających liczb, zatem wnioskujemy, że pora roku nie ma wpływu na to, czy trzęsienie ziemi wystąpi, czy nie.

### Badanie Zależności między porą dnia, a liczbą trzęsień ziemi

```{r, echo=FALSE, fig.cap="\\label{numb_time}Wykres kolumnowy ilości trzęsień ziemi w stosunku do godziny, w której wystąpiły? XD"}
time_rounded <- rep(NA,length(earthquakes$Time))
for (i in 1:length(earthquakes$Time)){
  date_time <- paste(earthquakes$Date[i],earthquakes$Time[i])
 time_rounded[i] <- format(round(round_date(ymd_hms(date_time),'hour'), units="hours"), format="%H:%M") 
 
}
eq_to_time <- data.frame(number=table(time_rounded))
colnames(eq_to_time)[1] <- 'czas'
colnames(eq_to_time)[2] <- 'częstość'
eq_to_time <- eq_to_time %>% drop_na()

ggplot(eq_to_time,aes(x=czas,y=częstość)) + geom_col(fill='hotpink') + theme(axis.text.x = element_text(angle = 90)) +
  labs(y='liczba wystąpień')
```

Na potrzeby zrobienia wykresu, zaokrąglone, do najbliższej całkowitej godziny, zostały zmienne z kolumny $Time$. Tak jak przy badaniu wpływu pory roku, możemy zauważyć, że wartości znów są do siebie zbliżone, a zatem pora dnia również nie ma wpływu na występowanie trzęsień ziemi.

### Nwm czy dodawać te boxploty bo one nie badają niczego w sumie, tylko obrazują zakres naszych danych więc można je wrzucic może do przedstawienia danych? XDDD Bez sensu trochę ale no, to w sumie wszystko co się nadaje wrzuciłam to by można jeszcze pomyśleć czy to już czy jak, bo tak nwm czy nie mało trochę XD

## 3. Wnioski
